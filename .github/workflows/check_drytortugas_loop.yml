name: Dry Tortugas Hourly Loop Check

on:
  workflow_dispatch:

jobs:
  check-availability-loop:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install playwright
          playwright install chromium

      - name: Run Dry Tortugas loop
        run: |
          python - <<'EOF'
          import os
          import smtplib
          import time
          from email.mime.text import MIMEText
          from playwright.sync_api import sync_playwright
          from datetime import datetime, timedelta

          EMAIL_FROM = os.environ["EMAIL_FROM"]
          EMAIL_TO = os.environ["EMAIL_TO"]
          EMAIL_PASSWORD = os.environ["EMAIL_PASSWORD"]

          TARGET_DATE = "2026-04-09"
          URL = "https://www.drytortugas.com/overnight-camping-reservations/"

          def send_email(subject, body):
              msg = MIMEText(body)
              msg["Subject"] = subject
              msg["From"] = EMAIL_FROM
              msg["To"] = EMAIL_TO
              with smtplib.SMTP("smtp.gmail.com", 587) as server:
                  server.starttls()
                  server.login(EMAIL_FROM, EMAIL_PASSWORD)
                  server.send_message(msg)
              print(f"Email sent: {subject}")

          def check_availability():
              now_str = datetime.now().strftime("%Y-%m-%d %H:%M:%S CST")
              print(f"Checking Dry Tortugas availability at {now_str}")
              try:
                  with sync_playwright() as p:
                      browser = p.chromium.launch(headless=True)
                      page = browser.new_page()
                      page.goto(URL)
                      page.wait_for_timeout(5000)
                      body_text = page.inner_text("body")

                      if TARGET_DATE in body_text:
                          send_email(
                              f"Dry Tortugas Alert: {TARGET_DATE} Available! ({now_str})",
                              f"✅ {TARGET_DATE} is now available for booking. Checked at {now_str}"
                          )
                      else:
                          send_email(
                              f"Dry Tortugas Update: {TARGET_DATE} Not Available ({now_str})",
                              f"❌ {TARGET_DATE} is not available yet. Checked at {now_str}"
                          )
                      browser.close()
              except Exception as e:
                  send_email(f"Dry Tortugas Script Error ({now_str})", f"Something went wrong:\n{e}")
                  raise

          # Run the first check immediately
          check_availability()

          # Loop to check hourly
          while True:
              now = datetime.now()
              next_hour = (now + timedelta(hours=1)).replace(minute=0, second=0, microsecond=0)
              sleep_seconds = (next_hour - now).total_seconds()
              print(f"Sleeping {sleep_seconds} seconds until next check at {next_hour.strftime('%Y-%m-%d %H:%M:%S')}")
              time.sleep(sleep_seconds)
              check_availability()
          EOF
        env:
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
